#include <windows.h>
#include <stdio.h>
#include <stdarg.h>
#include <string.h>

#include "string.h"

// Externs for globals
extern HDC DAT_00437488;
extern HDC DAT_004374b4;
extern char DAT_00437506;
extern char DAT_00437507;
extern int DAT_00437508;
extern int DAT_0043750c;
extern int DAT_00437510;
extern int DAT_00437f4c;
extern int DAT_00437f50;

extern HGDIOBJ DAT_00437496;
extern int DAT_0043749a;
extern int DAT_0043749e;
extern int DAT_004374a2;
extern char DAT_00439446[256]; // TEXTMETRIC struct buffer

extern char DAT_00437490;
extern "C" unsigned short DAT_004374b2;  // C linkage (defined in globals.cpp)
extern int DAT_00437491;
extern int DAT_00437518;
extern int DAT_0043751c;
extern int DAT_004383ec;
extern int DAT_004383f4;
extern int DAT_00438404;
extern int DAT_0043840c;
extern int DAT_004374c2;
extern int DAT_004374ce;
extern int DAT_004374d6;
extern int DAT_004374da;
extern int DAT_00437514;
extern char DAT_004374c0;
extern char DAT_004374c1;
extern char DAT_00437f54;
extern int DAT_00437f56;
extern int DAT_00437f5a;
extern HDC g_WinGDC_0043841c;
extern HGDIOBJ DAT_00438424;

extern char DAT_00437520[256];  // Palette identity map
extern "C" unsigned char DAT_00437620[256];  // Palette data / State flags (C linkage)
extern int DAT_0043826c[32];    // Palette data
extern char DAT_00437720[];     // LOGPALETTE buffer
extern char DAT_00437afc[];     // inside DAT_00437720
extern char DAT_00437b4c[];     // inside DAT_00437b48 typically
extern char DAT_00437b48[];     // BGR palette buffer


// Far pointer storage for WinG
extern char* PTR_DAT_0043843c;
extern char DAT_00438446[256];
extern int DAT_00438442;
extern short DAT_00438440;
extern HANDLE DAT_004374ee;
extern HMODULE DAT_00438420;

// WinG function pointers
extern void* DAT_00438428;
extern void* DAT_0043842c;
extern void* DAT_00438430;
extern void* DAT_00438434;
extern void* DAT_00438438;

// External functions
extern "C" void* GetGameWindowHandle();
extern "C" int SetCursorVisible(unsigned int);

// Forward declarations
int InitStockFont(int);
extern "C" int GetColorBitDepth(void);

// Exported functions
extern "C" int InitMouseSettings(void);
extern "C" int InitVideoSystem(void);






// Additional globals for palette functions
extern HPALETTE g_Palette_0043748c;
extern HPALETTE DAT_004374ae;



// DAT_00423e92 - palette data for <8 bit depth (240 RGB triplets = 720 bytes)
static const unsigned char DAT_00423e92[720] = {
    0xc0, 0xdc, 0xc0, 0xa6, 0xca, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xaa, 0x00, 0xaa, 0x00, 0x00,
    0xaa, 0xaa, 0xaa, 0x00, 0x00, 0xaa, 0x00, 0xaa, 0xaa, 0x55, 0x00, 0xaa, 0xaa, 0xaa, 0x55, 0x55,
    0x55, 0x55, 0x55, 0xff, 0x55, 0xff, 0x55, 0x55, 0xff, 0xff, 0xff, 0x55, 0x55, 0xff, 0x55, 0xff,
    0xff, 0xff, 0x55, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x55, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xff,
    0xff, 0xff, 0x00, 0x00, 0xff, 0x40, 0x00, 0xff, 0x7d, 0x00, 0xff, 0xbe, 0x00, 0xff, 0xff, 0x00,
    0xff, 0xff, 0x00, 0xbe, 0xff, 0x00, 0x7d, 0xff, 0x00, 0x40, 0xff, 0x00, 0x00, 0xff, 0x40, 0x00,
    0xff, 0x7d, 0x00, 0xff, 0xbe, 0x00, 0xff, 0xff, 0x00, 0xbe, 0xff, 0x00, 0x7d, 0xff, 0x00, 0x40,
    0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0x40, 0x00, 0xff, 0x7d, 0x00, 0xff, 0xbe, 0x00, 0xff,
    0xff, 0x00, 0xbe, 0xff, 0x00, 0x7d, 0xff, 0x00, 0x40, 0xff, 0x7d, 0x7d, 0xff, 0x9d, 0x7d, 0xff,
    0xbe, 0x7d, 0xff, 0xde, 0x7d, 0xff, 0xff, 0x7d, 0xff, 0xff, 0x7d, 0xde, 0xff, 0x7d, 0xbe, 0xff,
    0x7d, 0x9d, 0xff, 0x7d, 0x7d, 0xff, 0x9d, 0x7d, 0xff, 0xbe, 0x7d, 0xff, 0xde, 0x7d, 0xff, 0xff,
    0x7d, 0xde, 0xff, 0x7d, 0xbe, 0xff, 0x7d, 0x9d, 0xff, 0x7d, 0x7d, 0xff, 0x7d, 0x7d, 0xff, 0x9d,
    0x7d, 0xff, 0xbe, 0x7d, 0xff, 0xde, 0x7d, 0xff, 0xff, 0x7d, 0xde, 0xff, 0x7d, 0xbe, 0xff, 0x7d,
    0x9d, 0xff, 0xb6, 0xb6, 0xff, 0xc6, 0xb6, 0xff, 0xda, 0xb6, 0xff, 0xea, 0xb6, 0xff, 0xff, 0xb6,
    0xff, 0xff, 0xb6, 0xea, 0xff, 0xb6, 0xda, 0xff, 0xb6, 0xc6, 0xff, 0xb6, 0xb6, 0xff, 0xc6, 0xb6,
    0xff, 0xda, 0xb6, 0xff, 0xea, 0xb6, 0xff, 0xff, 0xb6, 0xea, 0xff, 0xb6, 0xda, 0xff, 0xb6, 0xc6,
    0xff, 0xb6, 0xb6, 0xff, 0xb6, 0xb6, 0xff, 0xc6, 0xb6, 0xff, 0xda, 0xb6, 0xff, 0xea, 0xb6, 0xff,
    0xff, 0xb6, 0xea, 0xff, 0xb6, 0xda, 0xff, 0xb6, 0xc6, 0xff, 0x00, 0x00, 0x71, 0x1c, 0x00, 0x71,
    0x38, 0x00, 0x71, 0x55, 0x00, 0x71, 0x71, 0x00, 0x71, 0x71, 0x00, 0x55, 0x71, 0x00, 0x38, 0x71,
    0x00, 0x1c, 0x71, 0x00, 0x00, 0x71, 0x1c, 0x00, 0x71, 0x38, 0x00, 0x71, 0x55, 0x00, 0x71, 0x71,
    0x00, 0x55, 0x71, 0x00, 0x38, 0x71, 0x00, 0x1c, 0x71, 0x00, 0x00, 0x71, 0x00, 0x00, 0x71, 0x1c,
    0x00, 0x71, 0x38, 0x00, 0x71, 0x55, 0x00, 0x71, 0x71, 0x00, 0x55, 0x71, 0x00, 0x38, 0x71, 0x00,
    0x1c, 0x71, 0x38, 0x38, 0x71, 0x44, 0x38, 0x71, 0x55, 0x38, 0x71, 0x61, 0x38, 0x71, 0x71, 0x38,
    0x71, 0x71, 0x38, 0x61, 0x71, 0x38, 0x55, 0x71, 0x38, 0x44, 0x71, 0x38, 0x38, 0x71, 0x44, 0x38,
    0x71, 0x55, 0x38, 0x71, 0x61, 0x38, 0x71, 0x71, 0x38, 0x61, 0x71, 0x38, 0x55, 0x71, 0x38, 0x44,
    0x71, 0x38, 0x38, 0x71, 0x38, 0x38, 0x71, 0x44, 0x38, 0x71, 0x55, 0x38, 0x71, 0x61, 0x38, 0x71,
    0x71, 0x38, 0x61, 0x71, 0x38, 0x55, 0x71, 0x38, 0x44, 0x71, 0x50, 0x50, 0x71, 0x59, 0x50, 0x71,
    0x61, 0x50, 0x71, 0x69, 0x50, 0x71, 0x71, 0x50, 0x71, 0x71, 0x50, 0x69, 0x71, 0x50, 0x61, 0x71,
    0x50, 0x59, 0x71, 0x50, 0x50, 0x71, 0x59, 0x50, 0x71, 0x61, 0x50, 0x71, 0x69, 0x50, 0x71, 0x71,
    0x50, 0x69, 0x71, 0x50, 0x61, 0x71, 0x50, 0x59, 0x71, 0x50, 0x50, 0x71, 0x50, 0x50, 0x71, 0x59,
    0x50, 0x71, 0x61, 0x50, 0x71, 0x69, 0x50, 0x71, 0x71, 0x50, 0x69, 0x71, 0x50, 0x61, 0x71, 0x50,
    0x59, 0x71, 0x00, 0x00, 0x40, 0x10, 0x00, 0x40, 0x20, 0x00, 0x40, 0x30, 0x00, 0x40, 0x40, 0x00,
    0x40, 0x40, 0x00, 0x30, 0x40, 0x00, 0x20, 0x40, 0x00, 0x10, 0x40, 0x00, 0x00, 0x40, 0x10, 0x00,
    0x40, 0x20, 0x00, 0x40, 0x30, 0x00, 0x40, 0x40, 0x00, 0x30, 0x40, 0x00, 0x20, 0x40, 0x00, 0x10,
    0x40, 0x00, 0x00, 0x40, 0x00, 0x00, 0x40, 0x10, 0x00, 0x40, 0x20, 0x00, 0x40, 0x30, 0x00, 0x40,
    0x40, 0x00, 0x30, 0x40, 0x00, 0x20, 0x40, 0x00, 0x10, 0x40, 0x20, 0x20, 0x40, 0x28, 0x20, 0x40,
    0x30, 0x20, 0x40, 0x38, 0x20, 0x40, 0x40, 0x20, 0x40, 0x40, 0x20, 0x38, 0x40, 0x20, 0x30, 0x40,
    0x20, 0x28, 0x40, 0x20, 0x20, 0x40, 0x28, 0x20, 0x40, 0x30, 0x20, 0x40, 0x38, 0x20, 0x40, 0x40,
    0x20, 0x38, 0x40, 0x20, 0x30, 0x40, 0x20, 0x28, 0x40, 0x20, 0x20, 0x40, 0x20, 0x20, 0x40, 0x28,
    0x20, 0x40, 0x30, 0x20, 0x40, 0x38, 0x20, 0x40, 0x40, 0x20, 0x38, 0x40, 0x20, 0x30, 0x40, 0x20,
    0x28, 0x40, 0x2c, 0x2c, 0x40, 0x30, 0x2c, 0x40, 0x34, 0x2c, 0x40, 0x3c, 0x2c, 0x40, 0x40, 0x2c,
    0x40, 0x40, 0x2c, 0x3c, 0x40, 0x2c, 0x34, 0x40, 0x2c, 0x30, 0x40, 0x2c, 0x2c, 0x40, 0x30, 0x2c,
    0x40, 0x34, 0x2c, 0x40, 0x3c, 0x2c, 0x40, 0x40, 0x2c, 0x3c, 0x40, 0x2c, 0x34, 0x40, 0x2c, 0x30,
    0x40, 0x2c, 0x2c, 0x40, 0x2c, 0x2c, 0x40, 0x30, 0x2c, 0x40, 0x34, 0x2c, 0x40, 0x3c, 0x2c, 0x40,
    0x40, 0x2c, 0x3c, 0x40, 0x2c, 0x34, 0x40, 0x2c, 0x30, 0x40, 0xff, 0xfb, 0xf0, 0xa0, 0xa0, 0xa4
};

// DAT_00423e98 - palette data for >=8 bit depth (236 RGB triplets = 708 bytes)
static const unsigned char DAT_00423e98[708] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0xaa, 0x00, 0xaa, 0x00, 0x00, 0xaa, 0xaa, 0xaa, 0x00, 0x00, 0xaa,
    0x00, 0xaa, 0xaa, 0x55, 0x00, 0xaa, 0xaa, 0xaa, 0x55, 0x55, 0x55, 0x55, 0x55, 0xff, 0x55, 0xff,
    0x55, 0x55, 0xff, 0xff, 0xff, 0x55, 0x55, 0xff, 0x55, 0xff, 0xff, 0xff, 0x55, 0xff, 0xff, 0xff,
    0x00, 0x00, 0x00, 0x55, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xff, 0xff, 0xff, 0x00, 0x00, 0xff, 0x40,
    0x00, 0xff, 0x7d, 0x00, 0xff, 0xbe, 0x00, 0xff, 0xff, 0x00, 0xff, 0xff, 0x00, 0xbe, 0xff, 0x00,
    0x7d, 0xff, 0x00, 0x40, 0xff, 0x00, 0x00, 0xff, 0x40, 0x00, 0xff, 0x7d, 0x00, 0xff, 0xbe, 0x00,
    0xff, 0xff, 0x00, 0xbe, 0xff, 0x00, 0x7d, 0xff, 0x00, 0x40, 0xff, 0x00, 0x00, 0xff, 0x00, 0x00,
    0xff, 0x40, 0x00, 0xff, 0x7d, 0x00, 0xff, 0xbe, 0x00, 0xff, 0xff, 0x00, 0xbe, 0xff, 0x00, 0x7d,
    0xff, 0x00, 0x40, 0xff, 0x7d, 0x7d, 0xff, 0x9d, 0x7d, 0xff, 0xbe, 0x7d, 0xff, 0xde, 0x7d, 0xff,
    0xff, 0x7d, 0xff, 0xff, 0x7d, 0xde, 0xff, 0x7d, 0xbe, 0xff, 0x7d, 0x9d, 0xff, 0x7d, 0x7d, 0xff,
    0x9d, 0x7d, 0xff, 0xbe, 0x7d, 0xff, 0xde, 0x7d, 0xff, 0xff, 0x7d, 0xde, 0xff, 0x7d, 0xbe, 0xff,
    0x7d, 0x9d, 0xff, 0x7d, 0x7d, 0xff, 0x7d, 0x7d, 0xff, 0x9d, 0x7d, 0xff, 0xbe, 0x7d, 0xff, 0xde,
    0x7d, 0xff, 0xff, 0x7d, 0xde, 0xff, 0x7d, 0xbe, 0xff, 0x7d, 0x9d, 0xff, 0xb6, 0xb6, 0xff, 0xc6,
    0xb6, 0xff, 0xda, 0xb6, 0xff, 0xea, 0xb6, 0xff, 0xff, 0xb6, 0xff, 0xff, 0xb6, 0xea, 0xff, 0xb6,
    0xda, 0xff, 0xb6, 0xc6, 0xff, 0xb6, 0xb6, 0xff, 0xc6, 0xb6, 0xff, 0xda, 0xb6, 0xff, 0xea, 0xb6,
    0xff, 0xff, 0xb6, 0xea, 0xff, 0xb6, 0xda, 0xff, 0xb6, 0xc6, 0xff, 0xb6, 0xb6, 0xff, 0xb6, 0xb6,
    0xff, 0xc6, 0xb6, 0xff, 0xda, 0xb6, 0xff, 0xea, 0xb6, 0xff, 0xff, 0xb6, 0xea, 0xff, 0xb6, 0xda,
    0xff, 0xb6, 0xc6, 0xff, 0x00, 0x00, 0x71, 0x1c, 0x00, 0x71, 0x38, 0x00, 0x71, 0x55, 0x00, 0x71,
    0x71, 0x00, 0x71, 0x71, 0x00, 0x55, 0x71, 0x00, 0x38, 0x71, 0x00, 0x1c, 0x71, 0x00, 0x00, 0x71,
    0x1c, 0x00, 0x71, 0x38, 0x00, 0x71, 0x55, 0x00, 0x71, 0x71, 0x00, 0x55, 0x71, 0x00, 0x38, 0x71,
    0x00, 0x1c, 0x71, 0x00, 0x00, 0x71, 0x00, 0x00, 0x71, 0x1c, 0x00, 0x71, 0x38, 0x00, 0x71, 0x55,
    0x00, 0x71, 0x71, 0x00, 0x55, 0x71, 0x00, 0x38, 0x71, 0x00, 0x1c, 0x71, 0x38, 0x38, 0x71, 0x44,
    0x38, 0x71, 0x55, 0x38, 0x71, 0x61, 0x38, 0x71, 0x71, 0x38, 0x71, 0x71, 0x38, 0x61, 0x71, 0x38,
    0x55, 0x71, 0x38, 0x44, 0x71, 0x38, 0x38, 0x71, 0x44, 0x38, 0x71, 0x55, 0x38, 0x71, 0x61, 0x38,
    0x71, 0x71, 0x38, 0x61, 0x71, 0x38, 0x55, 0x71, 0x38, 0x44, 0x71, 0x38, 0x38, 0x71, 0x38, 0x38,
    0x71, 0x44, 0x38, 0x71, 0x55, 0x38, 0x71, 0x61, 0x38, 0x71, 0x71, 0x38, 0x61, 0x71, 0x38, 0x55,
    0x71, 0x38, 0x44, 0x71, 0x50, 0x50, 0x71, 0x59, 0x50, 0x71, 0x61, 0x50, 0x71, 0x69, 0x50, 0x71,
    0x71, 0x50, 0x71, 0x71, 0x50, 0x69, 0x71, 0x50, 0x61, 0x71, 0x50, 0x59, 0x71, 0x50, 0x50, 0x71,
    0x59, 0x50, 0x71, 0x61, 0x50, 0x71, 0x69, 0x50, 0x71, 0x71, 0x50, 0x69, 0x71, 0x50, 0x61, 0x71,
    0x50, 0x59, 0x71, 0x50, 0x50, 0x71, 0x50, 0x50, 0x71, 0x59, 0x50, 0x71, 0x61, 0x50, 0x71, 0x69,
    0x50, 0x71, 0x71, 0x50, 0x69, 0x71, 0x50, 0x61, 0x71, 0x50, 0x59, 0x71, 0x00, 0x00, 0x40, 0x10,
    0x00, 0x40, 0x20, 0x00, 0x40, 0x30, 0x00, 0x40, 0x40, 0x00, 0x40, 0x40, 0x00, 0x30, 0x40, 0x00,
    0x20, 0x40, 0x00, 0x10, 0x40, 0x00, 0x00, 0x40, 0x10, 0x00, 0x40, 0x20, 0x00, 0x40, 0x30, 0x00,
    0x40, 0x40, 0x00, 0x30, 0x40, 0x00, 0x20, 0x40, 0x00, 0x10, 0x40, 0x00, 0x00, 0x40, 0x00, 0x00,
    0x40, 0x10, 0x00, 0x40, 0x20, 0x00, 0x40, 0x30, 0x00, 0x40, 0x40, 0x00, 0x30, 0x40, 0x00, 0x20,
    0x40, 0x00, 0x10, 0x40, 0x20, 0x20, 0x40, 0x28, 0x20, 0x40, 0x30, 0x20, 0x40, 0x38, 0x20, 0x40,
    0x40, 0x20, 0x40, 0x40, 0x20, 0x38, 0x40, 0x20, 0x30, 0x40, 0x20, 0x28, 0x40, 0x20, 0x20, 0x40,
    0x28, 0x20, 0x40, 0x30, 0x20, 0x40, 0x38, 0x20, 0x40, 0x40, 0x20, 0x38, 0x40, 0x20, 0x30, 0x40,
    0x20, 0x28, 0x40, 0x20, 0x20, 0x40, 0x20, 0x20, 0x40, 0x28, 0x20, 0x40, 0x30, 0x20, 0x40, 0x38,
    0x20, 0x40, 0x40, 0x20, 0x38, 0x40, 0x20, 0x30, 0x40, 0x20, 0x28, 0x40, 0x2c, 0x2c, 0x40, 0x30,
    0x2c, 0x40, 0x34, 0x2c, 0x40, 0x3c, 0x2c, 0x40, 0x40, 0x2c, 0x40, 0x40, 0x2c, 0x3c, 0x40, 0x2c,
    0x34, 0x40, 0x2c, 0x30, 0x40, 0x2c, 0x2c, 0x40, 0x30, 0x2c, 0x40, 0x34, 0x2c, 0x40, 0x3c, 0x2c,
    0x40, 0x40, 0x2c, 0x3c, 0x40, 0x2c, 0x34, 0x40, 0x2c, 0x30, 0x40, 0x2c, 0x2c, 0x40, 0x2c, 0x2c,
    0x40, 0x30, 0x2c, 0x40, 0x34, 0x2c, 0x40, 0x3c, 0x2c, 0x40, 0x40, 0x2c, 0x3c, 0x40, 0x2c, 0x34,
    0x40, 0x2c, 0x30, 0x40
};


#include "VBuffer.h"
extern VBuffer* g_WorkBuffer_00436974;
extern "C" int* GetWindowWidth();
extern "C" int* GetWindowHeight();

/* Function start: 0x419390 */
void BlankScreen() {
  if (g_WorkBuffer_00436974 != 0) {
    g_WorkBuffer_00436974->ClearScreen(0);
    VBuffer *vbuffer = g_WorkBuffer_00436974;
    vbuffer->CallBlitter5(
        vbuffer->clip_x1, vbuffer->clip_x2, vbuffer->clip_y1,
        vbuffer->clip_y2, 0, *GetWindowWidth() - 1, 0,
        *GetWindowHeight() - 1);
  }
}

/* Function start: 0x4193E0 */
extern "C" void FlipScreen() {
    //ShowMessage("FlipScreen called");
    VBuffer* vb;
    int* piVar1;
    int iVar2;
    int iVar3;
    
    if (g_WorkBuffer_00436974 == 0) {
        return;
    }
    vb = g_WorkBuffer_00436974;
    piVar1 = GetWindowHeight();
    iVar2 = *piVar1 - 1;
    iVar3 = 0;
    piVar1 = GetWindowWidth();
    vb->CallBlitter5(vb->clip_x1, vb->clip_x2, vb->clip_y1, vb->clip_y2, 0, *piVar1 - 1, iVar3, iVar2);
}

/* Function start: 0x4231BC */
extern "C" int InvalidateVideoMode() {
    DAT_00437f54 = (char)0xff;
    return 0;
}

/* Function start: 0x4231C6 */
extern "C" int GetCurrentVideoMode() {
    return (signed char)DAT_00437f54;
}

// Extern declarations for coordinate scaling
extern int DAT_004374c6;  // Video buffer width
extern int DAT_004374d2;  // Video buffer height

/* Function start: 0x42449b */
extern "C" int ScaleClientToBufferX(int x)
{
    RECT rect;
    HWND hWnd = GetActiveWindow();
    GetClientRect(hWnd, &rect);
    return (x * DAT_004374c6) / rect.right;
}

/* Function start: 0x4244c2 */
extern "C" int ScaleClientToBufferY(int y)
{
    RECT rect;
    HWND hWnd = GetActiveWindow();
    GetClientRect(hWnd, &rect);
    return (y * DAT_004374d2) / rect.bottom;
}

/* Function start: 0x4239E4 */
extern "C" int GetMousePosition(int* out_x, int* out_y)
{
    POINT pt;
    int x;
    int y;

    if (DAT_00437506 == 0) {
        goto fail;
    }
    GetCursorPos(&pt);
    {
        HWND hWnd = GetActiveWindow();
        ScreenToClient(hWnd, &pt);
    }
    x = ScaleClientToBufferX(pt.x);
    y = ScaleClientToBufferY(pt.y);
    if (x < 0 || x >= DAT_004374c6 || y < 0 || y >= DAT_004374d2) {
        goto fail;
    }
done:
    *out_x = x;
    *out_y = y;
    return 0;
fail:
    y = -1;
    x = y;
    goto done;
}

/* Function start: 0x423A54 */
int InitMouseSettings(void)
{
    HWND hWnd;
    int iVar2;
    
    hWnd = GetActiveWindow();
    DAT_00437510 = GetWindowWord(hWnd, -6);
    iVar2 = GetSystemMetrics(0x13);  // SM_SWAPBUTTON
    if (iVar2 != 0) {
        DAT_00437508 = GetSystemMetrics(0xd); // SM_CXDOUBLECLK
        DAT_0043750c = GetSystemMetrics(0xe); // SM_CYDOUBLECLK
        DAT_00437506 = 1;
        DAT_00437507 = 1;
        return 1;
    }
    DAT_00437506 = 0;
    return -1;
}

/* Function start: 0x423AAC */
int InitVideoSystem(void)
{
    DWORD DVar2;
    UINT UVar3;
    HMODULE pHVar4;
    int iVar5;
    char *pcVar6;
    char *pcVar7;
    char *pcVar8;
    int *puVar7;
    char cVar1;
    int uVar9;
    int bVar10;
    int lVar11;
    
    PTR_DAT_0043843c = DAT_00438446;
    DAT_00438442 = 0x1000;
    // DAT_00438440 = DS; // Segment register - skip
    
    InitStockFont(10);  // OEM_FIXED_FONT
    
    cVar1 = '\0';
    puVar7 = DAT_0043826c;
    for (iVar5 = 0x20; iVar5 != 0; iVar5 = iVar5 - 1) {
        *puVar7 = 0;
        puVar7 = puVar7 + 1;
    }
    puVar7 = (int*)DAT_00437620;
    for (iVar5 = 0x40; iVar5 != 0; iVar5 = iVar5 - 1) {
        *puVar7 = 0;
        puVar7 = puVar7 + 1;
    }
    iVar5 = 0x100;
    pcVar8 = DAT_00437520;
    do {
        *pcVar8 = cVar1;
        cVar1 = cVar1 + 1;
        iVar5 = iVar5 - 1;
        pcVar8 = pcVar8 + 1;
    } while (iVar5 != 0);
    
    uVar9 = 0x428;
    lVar11 = GetColorBitDepth();
    bVar10 = (unsigned int)lVar11 < 9;
    if (bVar10) {
        uVar9 = 0x228;
    }
    DAT_00437f50 = bVar10;
    DAT_00437f4c = uVar9;
    
    DAT_00437490 = 0;
    DAT_004374b2 = 0;
    DAT_00437491 = 0;
    DAT_00437518 = 0;
    DAT_0043751c = 0;
    DAT_004383ec = 0;
    DAT_004383f4 = 0;
    DAT_00438404 = 0;
    DAT_0043840c = 0;
    DAT_004374c2 = 0;
    DAT_004374ce = 0;
    DAT_004374d6 = 1;
    DAT_004374da = 1;
    DAT_00437514 = 1;
    DAT_004374c0 = (char)0xff;
    DAT_004374c1 = (char)0xff;
    DAT_00437f54 = (char)0xff;
    DAT_00437f56 = -1;
    DAT_00437f5a = -1;
    g_WinGDC_0043841c = 0;
    DAT_00438424 = 0;
    
    DVar2 = GetVersion();
    if (((unsigned short)DVar2 & 0xaff) == 0xa03) {
        // Windows 3.x with Win32s - try to load WING32.DLL
        DAT_004374ee = CreateFileA("WING32.DLL", 0x80000000, 1, (LPSECURITY_ATTRIBUTES)0x0, 3, 0, (HANDLE)0x0);
        if (DAT_004374ee == (HANDLE)-1) {
            UVar3 = GetSystemDirectoryA(DAT_00438446, 0x100);
            DAT_00438446[UVar3] = '\\';
            pcVar6 = "WING32.DLL";
            pcVar8 = &DAT_00438446[UVar3 + 1];
            for (iVar5 = 0xb; iVar5 != 0; iVar5 = iVar5 - 1) {
                *pcVar8 = *pcVar6;
                pcVar6 = pcVar6 + 1;
                pcVar8 = pcVar8 + 1;
            }
            DAT_004374ee = CreateFileA(DAT_00438446, 0x80000000, 1, (LPSECURITY_ATTRIBUTES)0x0, 3, 0, (HANDLE)0x0);
            if (DAT_004374ee == (HANDLE)-1) {
                return 0;
            }
        }
        CloseHandle(DAT_004374ee);
        pHVar4 = LoadLibraryA("WING32.DLL");
        if (pHVar4 != (HMODULE)0x0) {
            DAT_00438420 = pHVar4;
            // Get WinG function pointers using ordinals
            DAT_00438428 = (void*)GetProcAddress(pHVar4, (LPCSTR)2);
            if (DAT_00438428 == 0) return 0;
            DAT_0043842c = (void*)GetProcAddress(pHVar4, (LPCSTR)6);
            if (DAT_0043842c == 0) return 0;
            DAT_00438430 = (void*)GetProcAddress(pHVar4, (LPCSTR)3);
            if (DAT_00438430 == 0) return 0;
            DAT_00438434 = (void*)GetProcAddress(pHVar4, (LPCSTR)1);
            if (DAT_00438434 == 0) return 0;
            DAT_00438438 = (void*)GetProcAddress(pHVar4, (LPCSTR)10);
            if (DAT_00438438 == 0) return 0;
            // Call WinGRecommendDIBFormat (ordinal 3)
            typedef int (__stdcall *WinGRecommendDIBFormat_t)();
            g_WinGDC_0043841c = (HDC)((WinGRecommendDIBFormat_t)DAT_00438430)();
        }
    }
    return 0;
}

/* Function start: 0x423CD9 */
int GetColorBitDepth(void)
{
    unsigned int uVar1;
    unsigned int uVar2;
    
    uVar1 = GetDeviceCaps(DAT_00437488, 0xc);  // BITSPIXEL
    uVar2 = GetDeviceCaps(DAT_00437488, 0xe);  // PLANES
    return uVar2 * uVar1;
}

/* Function start: 0x423CFE */
extern "C" int CleanupVideoSystem() {
    int iVar1;
    int iVar2;
    int* piVar3;

    iVar2 = 0x20;
    piVar3 = DAT_0043826c;
    do {
        iVar1 = *piVar3;
        iVar2 = iVar2 - 1;
        piVar3 = piVar3 + 1;
    } while (iVar2 != 0 && iVar1 != 0);

    if (iVar1 == 0) {
        DAT_00437f54 = (char)0xff;
        if (DAT_004374ae != (HPALETTE)0) {
            SelectPalette(DAT_00437488, DAT_004374ae, 0);
        }
        if (g_WinGDC_0043841c != 0) {
            DeleteDC((HDC)g_WinGDC_0043841c);
            g_WinGDC_0043841c = 0;
            DAT_00438424 = 0;
            FreeLibrary(DAT_00438420);
        }
    }
    return 0;
}

/* Function start: 0x423D5B */
int SelectAndRealizePalette(HPALETTE param_1)
{
    HPALETTE pHVar1;
    
    g_Palette_0043748c = param_1;
    pHVar1 = SelectPalette(DAT_00437488, param_1, 0);
    RealizePalette(DAT_00437488);
    if (DAT_004374ae == (HPALETTE)0x0) {
        DAT_004374ae = pHVar1;
    }
    return 0;
}

/* Function start: 0x423D96 */
HPALETTE CreateSystemPalette(void)
{
  HDC hdc;
  unsigned char* pEntries;
  unsigned char* src;
  unsigned char* dest;
  unsigned char* pBgrDest;
  int count;
  unsigned char r, g;
  
  hdc = GetDC((HWND)0x0);
  pEntries = (unsigned char*)DAT_00437720 + 4;
  if (GetColorBitDepth() < 8) {
    GetSystemPaletteEntries(hdc, 0, 8, (PALETTEENTRY*)pEntries);
    GetSystemPaletteEntries(hdc, 8, 8, (PALETTEENTRY*)(pEntries + 0x3e0));
    ReleaseDC((HWND)0x0, hdc);
    dest = (unsigned char*)DAT_00437720 + 0x24;
    src = (unsigned char*)DAT_00423e92;
    count = 0xf0;
  }
  else {
    GetSystemPaletteEntries(hdc, 0, 10, (PALETTEENTRY*)pEntries);
    GetSystemPaletteEntries(hdc, 246, 10, (PALETTEENTRY*)(pEntries + 0x3d8));
    ReleaseDC((HWND)0x0, hdc);
    dest = (unsigned char*)DAT_00437720 + 0x2c;
    src = (unsigned char*)DAT_00423e98;
    count = 0xec;
  }
  
  // First copy loop: RGB triplet -> RGBX quad with flags=1
  do {
    dest[0] = src[0];  // Red
    dest[1] = src[1];  // Green
    dest[2] = src[2];  // Blue
    dest[3] = 1;       // Flags = PC_NOCOLLAPSE
    src = src + 3;
    dest = dest + 4;
    count = count - 1;
  } while (count != 0);
  
  // Second loop: Create BGR reordered copy at DAT_00437b4c
  pEntries = (unsigned char*)DAT_00437720 + 4;
  pBgrDest = (unsigned char*)DAT_00437b48 + 4;
  count = 0x100;
  do {
    r = pEntries[0];
    g = pEntries[1];
    pBgrDest[0] = pEntries[2];  // Blue
    pBgrDest[1] = g;            // Green
    pBgrDest[2] = r;            // Red
    pBgrDest[3] = 0;            // Reserved
    pEntries = pEntries + 4;
    pBgrDest = pBgrDest + 4;
    count = count - 1;
  } while (count != 0);
  
  return CreatePalette((LOGPALETTE *)DAT_00437720);
}

/* Function start: 0x424162 */
int SetDeviceContext(HDC param_1)
{
    DAT_00437488 = param_1;
    DAT_004374b4 = param_1;
    return 0;
}

/* Function start: 0x4244E9 */
int InitStockFont(int param_1)
{
    TEXTMETRICA *pTextMetric;
    
    DAT_00437496 = GetStockObject(param_1);
    SelectObject(DAT_004374b4, DAT_00437496);
    pTextMetric = (TEXTMETRICA *)DAT_00439446;
    GetTextMetricsA(DAT_004374b4, pTextMetric);
    DAT_0043749a = pTextMetric->tmHeight + pTextMetric->tmExternalLeading;
    DAT_0043749e = pTextMetric->tmExternalLeading;
    DAT_004374a2 = pTextMetric->tmAveCharWidth;
    return 0;
}

// FUN_00422ac3 - Complex Bresenham line drawing algorithm with segment manipulation
// Too complex to reimplement exactly due to inline assembly and segment registers
extern "C" int __cdecl FUN_00422ac3(int param_1, int param_2) { return 0; }

// Externs for video buffer access
extern int DAT_004374ca;  // buffer height - 1
extern int DAT_00437f5e;  // buffer stride
extern int DAT_00437f66;  // buffer base
extern int DAT_004374de;  // clip left
extern int DAT_004374e2;  // clip right
extern int DAT_004374e6;  // clip top
extern int DAT_004374ea;  // clip bottom
static void DrawEllipseScanline(int y, int left_x, int right_x) {
    if (y < DAT_004374e6 || y > DAT_004374ea) return;
    if (right_x < DAT_004374de) return;
    if (left_x > DAT_004374e2) return;

    int flags = 0;
    if (left_x < DAT_004374de) flags = 2;
    if (right_x > DAT_004374e2) flags |= 1;

    int row = DAT_004374ca - y;
    unsigned char* base = (unsigned char*)(row * DAT_00437f5e + DAT_00437f66);
    unsigned char color = (unsigned char)DAT_00437490;

    if (!(flags & 2)) {
        base[left_x] = color;
    }
    if (!(flags & 1)) {
        base[right_x] = color;
    }
}

/* Function start: 0x424176 */
extern "C" int __cdecl FUN_00424176(int param_1, int param_2) {
    if ((signed char)DAT_00437f54 < 0) return 0;
    if (param_1 <= 0 || param_2 <= 0) return 0;

    unsigned short rx = (unsigned short)param_1;
    unsigned short ry = (unsigned short)param_2;

    unsigned long a2 = (unsigned long)rx * rx;
    unsigned long b2 = (unsigned long)ry * ry;
    unsigned long two_a2 = a2 * 2;
    unsigned long two_b2 = b2 * 2;

    long term_x = 0;
    long term_y = (long)(two_a2 * ry);
    long d = (long)(b2 + (a2 >> 2) - a2 * ry);

    int x = 0;
    int y = (int)ry;

    // First region: where dy/dx < 1
    while (term_x <= term_y) {
        int center_x = DAT_004374c2;
        int center_y = DAT_004374ce;
        int draw_y;

        // Draw top scanline (center_y - y)
        draw_y = center_y - y;
        DrawEllipseScanline(draw_y, center_x - x, center_x + x);

        // Draw bottom scanline (center_y + y)
        draw_y = center_y + y;
        DrawEllipseScanline(draw_y, center_x - x, center_x + x);

        if (d >= 0) {
            y--;
            term_y -= two_a2;
            d -= term_y;
        }

        x++;
        term_x += two_b2;
        d += (long)(b2 + term_x);
    }

    // Correction term for transition between regions
    d += (long)((3 * (a2 - b2) / 2 - (term_x + term_y)) / 2);

    // Second region: where dy/dx >= 1
    while (y >= 0) {
        int center_x = DAT_004374c2;
        int center_y = DAT_004374ce;
        int draw_y;

        // Draw top scanline
        draw_y = center_y - y;
        DrawEllipseScanline(draw_y, center_x - x, center_x + x);

        // Draw bottom scanline
        draw_y = center_y + y;
        DrawEllipseScanline(draw_y, center_x - x, center_x + x);

        if (d < 0) {
            x++;
            term_x += two_b2;
            d += term_x;
        }

        y--;
        term_y -= two_a2;
        d += (long)(a2 - term_y);
    }

    return 0;
}

/* Function start: 0x422aaf */
extern "C" int __cdecl FUN_00422aaf(int param_1) {
    FUN_00424176(param_1, param_1);
    return 0;
}
